(function(){var h,d,f,c,a,e,g,b=function(i,j){return function(){return i.apply(j,arguments)}};f=(function(){function i(){}i.validate=function(j){return j.val(this.replaceHTML(j.val()))};i.replaceHTML=function(j){return j.replace(/[&<>"']/g,function(k){return"&"+{"&":"amp","<":"lt",">":"gt",'"':"quot","'":"#39"}[k]+";"})};return i})();a=(function(){function i(){this.socket=io.connect(window.location.hostname)}i.prototype.listen=function(j,k){return this.socket.on(j,function(l){return k(l)})};i.prototype.sendSocketData=function(j,k){return this.socket.emit(j,k)};i.prototype.sendRecieveData=function(j,k,l){return this.socket.emit(j,k,function(m){return l(m)})};return i})();d=(function(){function i(){this.displayCurrentResearch=b(this.displayCurrentResearch,this);this.socketSupport=new a();this.currentResearch=[];this.askForRealtimeInfo();this.listenForNewAreasBeingResearched();this.tellServerImHome()}i.prototype.askForRealtimeInfo=function(){return this.socketSupport.sendRecieveData("whatsBeingResearched",{},this.displayCurrentResearch)};i.prototype.tellServerImHome=function(){return this.socketSupport.sendSocketData("whereAmI","home")};i.prototype.listenForNewAreasBeingResearched=function(){return this.socketSupport.listen("newResearchHappening",this.displayCurrentResearch)};i.prototype.displayCurrentResearch=function(m){var j,l,k,n;console.log("data recieved = ",m);j=[];for(l in m){n=m[l];j.push({name:l,number:n})}if(j.length>0){this.currentResearch={results:j};k=Mustache.to_html($("#current-research-template").html(),this.currentResearch);return $("#current-research-container").html(k)}else{return $("#current-research-container").html("")}};return i})();$(function(){var i;if($("#isHome").length>0){return i=new d()}});c=(function(){function i(){}i.prototype.addResultToCache=function(k,j){if(this.exists(k)){return localStorage.setItem(k,this.getHtml(k)+j)}else{return localStorage.setItem(k,j)}};i.prototype.getHtml=function(j){return this.findResult(j)};i.prototype.exists=function(j){return this.findResult(j)!=null};i.prototype.findResult=function(j){return localStorage.getItem(j)};i.prototype.keys=function(){return Object.keys(localStorage)};return i})();h=(function(){var l,i,j,n,k,m,o;function p(){this.listenForChat=b(this.listenForChat,this);this.handleChatEntered=b(this.handleChatEntered,this);this.handleUsernameEntered=b(this.handleUsernameEntered,this);this.listenForOtherUsers=b(this.listenForOtherUsers,this);if(o){this.areaName=$("#area-id").text();this.socketSupport=new a();this.numberOfUsers=1;this.showHideChat;this.userName="";this.hideChatForm();this.listenForOtherUsers();this.handleUsernameEntered();this.handleChatEntered();this.listenForChat()}}p.prototype.listenForOtherUsers=function(){var q=this;return this.socketSupport.listen("newResearchHappening",function(r){q.numberOfUsers=r[q.areaName];q.showHideChat();m.text(q.numberOfUsers-1);return i.text(q.areaName)})};p.prototype.handleUsernameEntered=function(){var q=this;return $("#chat .alias-form").submit(function(r){r.preventDefault();q.userName=l.val();if(q.userName.length>0){q.showChatForm();n.focus();return q.hideAliasForm()}})};p.prototype.handleChatEntered=function(){var q=this;return $("#chat .chat-form").submit(function(s){var r;s.preventDefault();r=n.val();n.val("");if(r.length>0){return q.sendMessage(r)}})};p.prototype.sendMessage=function(q){var r;r={user:this.userName,message:q,area:this.areaName};return this.socketSupport.sendSocketData("chatMessage",r)};p.prototype.listenForChat=function(){var q=this;return this.socketSupport.listen("recieveChat",function(r){if(r.area===q.areaName){return q.addChatLine(r.user,r.message)}})};p.prototype.addChatLine=function(q,r){return $("#chat ul").append("<li><strong>"+q+"</strong>: "+r+"</li>")};p.prototype.showHideChat=function(){if(this.numberOfUsers>1){return this.displayChat()}else{return this.hideChat()}};p.prototype.displayChat=function(){return k.show()};p.prototype.hideChat=function(){return k.hide()};p.prototype.hideChatForm=function(){return j.hide()};p.prototype.showChatForm=function(){return j.show()};p.prototype.hideAliasForm=function(){return $("#chat .alias-form").hide()};k=(function(){return $("section#chat")})();o=(function(){return k.length>0})();n=(function(){return $("#chat .text-input")})();j=(function(){return $("#chat .chat-form")})();l=(function(){return $("#chat .alias")})();m=(function(){return $("#chat .number-of-users")})();i=(function(){return $("#chat .chat-area")})();return p})();$(function(){var i;return i=new h()});g=(function(){var i;function j(){this.areaName=$("#area-id").text();this.registerTagButtons();this.getTaggedDocuments();this.socketSupport=new a();this.listenForTagAdded();this.socketSupport.sendSocketData("whereAmI",this.areaName)}j.prototype.registerTagButtons=function(){var k=this;return $(".tag").live("click",function(l){var m;m={doi:$(l.currentTarget).attr("doi"),title:$(l.currentTarget).attr("title"),area:k.areaName};console.log("tag data = ",m);k.socketSupport.sendSocketData("addTaggedDocument",m);$.ajax({type:"POST",data:m,url:"/tag"});return false})};j.prototype.getTaggedDocuments=function(){var k;k="/tag/"+this.areaName;return $.ajax({url:k,dataType:"json",type:"GET",success:function(l){return i(l)}})};i=function(l){var k;k=Mustache.to_html($("#tagged-template").html(),l);return $("#tagged-container").html(k)};j.prototype.listenForTagAdded=function(){return this.socketSupport.listen("taggedDocumentAdded",function(k){return $("#tagged-container ol").append("<li><a href='http://rd.springer.com/"+k.doi+"'>"+k.title+"</a></li>")})};return j})();$(function(){var i;if($("#tagged-container").length>0){return i=new g()}});e=(function(){var n,j,m,i,l;function k(){this.resultsCache=new c;this.handleSubmit();this.handleLoadMore();this.handleEmpty();n.hide()}k.prototype.doSearch=function(o){i.attr("value","Searching");this.term=m.val();if(this.resultsCache.exists(this.term)){this.renderResult(this.term);return n.show()}else{return this.getResult(this.term)}};k.prototype.getResult=function(p,q){var r,o,s=this;if(q==null){q=1}q=parseInt(q);if(q===1){r=1}else{r=q*10}o="http://api.springer.com/metadata/jsonp?q="+p+"&api_key=ueukuwx5guegu4ahjc6ajq8w&s="+r+"&callback=?";console.log(o);return $.ajax({url:o,dataType:"jsonp",type:"GET",success:function(u){var t;i.attr("value","Search");t=Mustache.to_html($("#template").html(),u);s.resultsCache.addResultToCache(p,t);return s.renderResult(p)}})};k.prototype.renderResult=function(o){j.html(this.resultsCache.getHtml(o));l();i.attr("value","Search");n.text("Load more");return n.show()};k.prototype.handleSubmit=function(){var o=this;return $("#search-form").submit(function(p){p.preventDefault();return o.doSearch()})};k.prototype.handleLoadMore=function(){var o=this;return n.click(function(){var q,p;p=$("li").length-1;q=(p/10)+1;n.text("Loading more...");o.getResult(o.term,q);return false})};k.prototype.handleEmpty=function(){return $("#empty-cache").click(function(){localStorage.clear();return false})};l=function(){var o;o=j.find("ol").length;if(o>1){return j.find("li").each(function(){j.find("ol:first").append($(this));return j.find("ol").not(":first").remove()})}};n=(function(){return $("#load-more")})();i=(function(){return $("#search-button")})();j=(function(){return $("#results")})();m=(function(){return $("#search")})();return k})();$(function(){var i;if($("#search").length>0){return i=new e()}})}).call(this);